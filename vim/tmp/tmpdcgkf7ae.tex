% Input your problem and solution below.
% Three dashes on a newline indicate the breaking points.

---

Find all positive integers $n$ such that there exists a sequence of positive integers $a_1$, $a_2$, \ldots, $a_n$ satisfying \[a_{k+1}=\frac{a_k^2+1}{a_{k-1}+1}-1\]
for every $k$ with $2\le k\le n-1$.

---

The answer is $n\le4$, achieved by $4$, $33$, $217$, $1384$. First observe that
\begin{itemize}[itemsep=0em]
    \item $a_{k-1}$ odd and $a_k$ even imply $a_{k+1}$ does not exist;
    \item $a_{k-1}$ odd and $a_k$ odd imply $a_{k+1}$ even;
    \item $a_{k-1}$ even and $a_k$ odd imply $a_{k+1}$ odd.
    \item $a_{k-1}$ even and $a_k$ even imply $a_{k+1}$ even.
\end{itemize}
Hence unless the sequence is forever even, its maximum length is four.
\begin{lemma*}
    If $a$, $b$ are even, then $a+1\mid b^2+1$ and $b+1\mid a^2+1$ cannot simultaneously hold.
\end{lemma*}
\begin{proof}
    The proof is Vieta jumping: take the minimal pair $(a,b)$, and let \[\frac{b^2+1}{a+1}=m+1\quad\text{and}\quad\frac{a^2+1}{b+1}=n+1.\]
    We cannot simultaneously have $m\ge a$ and $n\ge b$, so without loss of generality $m<a$.

    Note $\gcd(a,b+1)=\gcd(a+1,b+1)=1$ since $b+1\mid a^2+1$, $a\mid a^2$, $a+1\mid a^2-1$. By design, $m+1\mid b^2+1$ and \[m^2+1\equiv\left(\frac{b^2+1}{a+1}-1\right)^2+1\equiv\left(\frac{1-a}{1+a}\right)^2+1\equiv\frac{-2a}{2a}+1\equiv0\pmod{b+1},\]
    so $(m,b)$ is a smaller pair that works.
\end{proof}

But if the sequence is all even and has length at least four, then both $a_2+1\mid a_3^2+1$ and $a_3+1\mid a_2^2+1$ hold, contradiction.

