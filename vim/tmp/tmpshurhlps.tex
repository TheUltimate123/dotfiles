% Input your problem and solution below.
% Three dashes on a newline indicate the breaking points.

---

Find all functions $f:(0,\infty)\to(0,\infty)$ such that for any $x,y\in(0,\infty)$, \[xf\big(x^2\big)f(f(y))+f(yf(x))=f(xy)\left(f\big(f\big(x^2\big)\big)+f(f(y^2))\right).\]

---

The answer is $f(x)=1/x$, which can be easily verified to work. Let $P(x,y)$ denote the assertion. First $P(1,1)$ yields $f(1)=1$. We now work to prove a few identities.
\setcounter{iclaim}0
\begin{iclaim}
    For all $x$,
    \begin{enumerate}[label=(\roman*),itemsep=0em]
        \item $xf\big(x^2\big)=f(x)$,
        \item $f(1/x)f(f(x))=f\big(f\big(x^2\big)\big)$,
        \item $f(x)f(1/x)=1$.
    \end{enumerate}
\end{iclaim}
\begin{proof}[Proof of identity \emph{(i)}]
    $P(x,1)$ and $P(1,x)$ give \[xf\big(x^2\big)+f(f(x))=f(x)\left(f\big(f\big(x^2\big)\big)+1\right)=f(f(x))+f(x),\]
    from which the claim follows. We now express the left-hand expression as $f(x)f(f(y))+f(yf(x))$ for convenience.
\end{proof}
\begin{proof}[Proof of identity \emph{(ii)}]
    $P(1/x,x)$ gives \[f\left(\frac1x\right)f(f(x))+f\left(xf\left(\frac1x\right)\right)=f\big(f\big(x^2\big)\big)+f\left(f\left(\frac1{x^2}\right)\right).\]
    However by the first identity, $f(xf(1/x))=f\big(f\big(1/x^2\big)\big)$, so the claim follows.
\end{proof}
\begin{proof}[Proof of identity \emph{(iii)}]
    With the above identities, $P(x,1)$ now says \[f(x)+f(f(x))=f(x)\left(f\left(\frac1x\right)f(f(x))+1\right),\]
    which rearranges to $f(x)f(1/x)=1$. Additionally identity (ii) now reads $f(f(x))/f(x)=f\big(f\big(x^2\big)\big)$.
\end{proof}

With this, we may turn to the task of proving injectivity.
\begin{iclaim}
    $f$ is injective.
\end{iclaim}
\begin{proof}
    Say that $f(a)=f(b)$. By identity (ii), $f\big(f\big(a^2\big)\big)=f\big(f\big(b^2\big)\big)$. Combining the assertions $P(a,b)$ and $P(b,a)$, we find \[f(a)f(f(b))+f(bf(a))=f(b)f(f(a))+f(af(b)),\]
    whence $f(af(a))=f(af(b))=f(bf(a))=f(bf(b))$. Now if $X=2f\big(f\big(a^2\big)\big)=2f\big(f\big(a^2\big)\big)$, $P(a,a)$ and $P(b,b)$ yield \[Xf\big(a^2\big)=f(a)f(f(a))+f(af(a))=f(b)f(f(b))+f(bf(b))=Xf\big(b^2\big).\]
    Noting that $f\big(a^2\big)=f(a)/a$ proves injectivity.
\end{proof}

To finish, remark that \[f\big(f\big(x\big)^2\big)\stackrel{\text{(i)}}=\frac{f(f(x))}{f(x)}\stackrel{\text{(iii)}}=f\big(f\big(x^2\big)\big),\]
so by injectivity $f(x)^2=f\big(x^2\big)=f(x)/x$, and $f(x)=1/x$ for all $x$. This completes the proof.

