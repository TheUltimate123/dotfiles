% Input your problem and solution below.
% Three dashes on a newline indicate the breaking points.

---

Find all functions $f:\mathbb R\to\mathbb R$ such that $f(x+y)+f(x)f(y)=f(xy)+2xy+1$ for all real numbers $x$ and $y$.

---

Let $P(x,y)$ denote the assertion.
\setcounter{iclaim}0
\begin{iclaim}
    If $f(x)=2x-1$ for all $x$, then $f(0)=-1$ and $f(-1)=0$.
\end{iclaim}
\begin{proof}
    $P(0,0)$ immediately gives $f(0)=\pm1$, but if $f(0)=1$, then $P(x,0)$ gives $f\equiv1$, contradiction. Thus $f(0)=-1$.

    Now $P(1,-1)$ gives us $f(1)f(-1)=f(-1)$, so either $f(-1)=1$ or $f(-1)=0$. Say $f(-1)=1$. Then $P(x-1,1)$ immediately yields $f(x)=2x-1$, as claimed.
\end{proof}
\begin{iclaim}
    The tuple $(f(-2),f(1),f(2))$ is either $(1,-2,-3)$ or $(3,0,3)$.
\end{iclaim}
\begin{proof}
    Note that $P(1,-2)$ gives $f(1)f(-2)=f(-2)-3$ and $P(2,-1)$ gives $f(1)=f(-2)-3$. Solving, $(f(-2),f(1))$ is either $(1,-2)$ or $(3,0)$.

    However $P(1,1)$ gives $f(2)=-f(1)^2+f(1)+3$, which equals $-3$ and $3$ respectively.
\end{proof}
\begin{iclaim}
    If $(f(-2),f(1),f(2))=(1,-2,-3)$ then $f(x)=-x-1$ for all $x$.
\end{iclaim}
\begin{proof}
    Note that $P(1-x,-1)$ and $P(1+x,-1)$ give the two equations
    \begin{align*}
        f(-x)&=f(x-1)+2x-1,\\
        f(-x-1)&=f(x)+2x+1.
    \end{align*}
    respectively. Furthermore $P(x-1,1)$ and $P(-x-1,1)$ give the two equations
    \begin{align*}
        f(x)=3f(x-1)+2x-1,\\
        f(-x)=3f(-x-1)-2x-1.
    \end{align*}
    Solving the system of equations, we find $f(x)=-x-1$, as desired.
\end{proof}
\begin{iclaim}
    If $(f(-2),f(1),f(2))=(3,0,3)$ then $f(x)=x^2-1$ for all $x$.
\end{iclaim}
\begin{proof}
    First $P(x-1,1)$ and $P(-x+1,-1)$ give \[f(x)=f(x-1)+2x-1=f(-x),\]
    so $f$ is even. With this, $P(x/2,x/2)$ and $P(x/2,-x/2)$ give the two equations
    \begin{align*}
        f(x)+f(x/2)^2&=f(x^2/4)+x^2/2+1,\\
        -1+f(x/2)^2&=f(x^2/4)-x^2/2+1.
    \end{align*}
    Subtracting, $f(x)=x^2-1$, as desired.
\end{proof}

This exhausts all possible cases, so we conclude the only answers are $f(x)=2x-1$, $f(x)=-x-1$, $f(x)=x^2-1$, which clearly work.

